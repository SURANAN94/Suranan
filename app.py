import io
import pandas as pd
import streamlit as st

st.set_page_config(
    page_title="ЁЯФН р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕бр╕╖р╕нр╕гр╕зр╕бр╕Вр╣Йр╕нр╕бр╕╣р╕е Excel By SURANAN ",
    page_icon="ЁЯУК",
    layout="centered",
)

# ---------------------------------------------------------
# р╕кр╣Ир╕зр╕Щр╕лр╕▒р╕зр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ
# ---------------------------------------------------------

st.title("ЁЯФН  р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕бр╕╖р╕нр╕гр╕зр╕бр╕Вр╣Йр╕нр╕бр╕╣р╕е Excel
р╕Ир╕▒р╕Фр╕Чр╕│р╣Вр╕Фр╕в р╕Щр╕▓р╕в р╕кр╕╕р╕гр╕Щр╕▒р╕Щр╕Чр╣М р╕вр╕▓р╕бр╕Фр╕╡ 
р╣Вр╕гр╕Зр╕Юр╕вр╕▓р╕Ър╕▓р╕ер╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕кр╕╕р╕Вр╕ар╕▓р╕Юр╕Хр╕│р╕Ър╕ер╕Ър╣Йр╕▓р╕Щр╣Вр╕Щр╕Щр╕Др╣Йр╕н ")

st.markdown(
    """
**р╕зр╕┤р╕Шр╕╡р╣Гр╕Кр╣Й**  
1. р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф **F1** (р╣Др╕Яр╕ер╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕ер╕▒р╕Б)  
2. р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф **F2** (р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕▓р╕Б)  
3. р╣Ар╕ер╕╖р╕нр╕Бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Др╕╡р╕вр╣Мр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕Ир╕▒р╕Ър╕Др╕╣р╣И (р╣Ар╕Кр╣Ир╕Щ `PID`) р╕Вр╕нр╕Зр╣Бр╕Хр╣Ир╕ер╕░р╣Др╕Яр╕ер╣М  
4. р╣Ар╕ер╕╖р╕нр╕Б **р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Ир╕▓р╕Б F2** р╣Др╕Фр╣Йр╕Чр╕╡р╕ер╕░р╕лр╕ер╕▓р╕вр╕Др╕нр╕ер╕▒р╕бр╕Щр╣М  
5. р╕Бр╕Фр╕Ыр╕╕р╣Ир╕б **р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф** р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ър╣Др╕Яр╕ер╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
"""
)

# ---------------------------------------------------------
# р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕нр╣Ир╕▓р╕Щ Excel
# ---------------------------------------------------------

def read_excel(uploaded_file: "st.uploaded_file") -> pd.DataFrame:
    """р╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣М Excel р╕Чр╕╕р╕Бр╕Кр╕╡р╕Хр╣Бр╕ер╣Йр╕зр╕Хр╣Ир╕нр╕Бр╕▒р╕Щр╣Ар╕Ыр╣Зр╕Щ DataFrame р╣Ар╕Фр╕╡р╕вр╕з"""
    try:
        sheets = pd.read_excel(uploaded_file, sheet_name=None)
        if isinstance(sheets, dict):
            return pd.concat(sheets.values(), ignore_index=True)
        return sheets
    except Exception as e:
        st.error(f"тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣М: {e}")
        return pd.DataFrame()

# ---------------------------------------------------------
# р╣Вр╕Лр╕Щр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М
# ---------------------------------------------------------

f1_file = st.file_uploader("ЁЯУд р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф F1 (р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕ер╕▒р╕Б)", type=["xlsx", "xls"], key="f1")
f2_file = st.file_uploader("ЁЯУд р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф F2 (р╣Др╕Яр╕ер╣Мр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З)", type=["xlsx", "xls"], key="f2")

if f1_file and f2_file:
    df1 = read_excel(f1_file)
    df2 = read_excel(f2_file)

    if df1.empty or df2.empty:
        st.stop()

    # -----------------------------------------------------
    # р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ир╕▒р╕Ър╕Др╕╣р╣Ир╣Бр╕ер╕░р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
    # -----------------------------------------------------

    st.subheader("тЪЩя╕П р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Бр╕▓р╕гр╕Ир╕▒р╕Ър╕Др╕╣р╣Ир╣Бр╕ер╕░р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М")

    pid_col1 = st.selectbox(
        "р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Др╕╡р╕вр╣Мр╣Гр╕Щ F1 (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ир╕▒р╕Ър╕Др╕╣р╣И)", df1.columns.tolist(), index=df1.columns.tolist().index("PID") if "PID" in df1.columns else 0
    )

    pid_col2 = st.selectbox(
        "р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Др╕╡р╕вр╣Мр╣Гр╕Щ F2 (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ир╕▒р╕Ър╕Др╕╣р╣И)", df2.columns.tolist(), index=df2.columns.tolist().index("PID") if "PID" in df2.columns else 0
    )

    result_cols = st.multiselect(
        "р╣Ар╕ер╕╖р╕нр╕Бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Ир╕▓р╕Б F2 (р╣Ар╕ер╕╖р╕нр╕Бр╣Др╕Фр╣Йр╕лр╕ер╕▓р╕вр╕Др╕нр╕ер╕▒р╕бр╕Щр╣М)",
        [c for c in df2.columns if c != pid_col2],
    )

    st.divider()

    # -----------------------------------------------------
    # р╕Ыр╕╕р╣Ир╕бр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е
    # -----------------------------------------------------

    if st.button("ЁЯФД р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф"):
        if not result_cols:
            st.warning("тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕нр╕вр╣Ир╕▓р╕Зр╕Щр╣Йр╕нр╕в 1 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Бр╣Ир╕нр╕Щр╕Др╕гр╕▒р╕Ъ")
            st.stop()

        # р╕Чр╕│р╕Бр╕▓р╕г merge р╕Др╕гр╕▒р╣Йр╕Зр╣Ар╕Фр╕╡р╕вр╕зр╕Фр╣Йр╕зр╕вр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
        merged = df1.merge(
            df2[[pid_col2] + result_cols],
            left_on=pid_col1,
            right_on=pid_col2,
            how="left",
        )

        # р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Кр╕╖р╣Ир╕нр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Гр╕лр╣Йр╕бр╕╡ _lookup р╕Хр╣Ир╕нр╕Чр╣Йр╕▓р╕в (р╕Бр╕▒р╕Щр╕Лр╣Йр╕│)
        rename_map = {col: f"{col}_lookup" for col in result_cols}
        merged.rename(columns=rename_map, inplace=True)

        # р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М Excel р╣Гр╕Щр╕лр╕Щр╣Ир╕зр╕вр╕Др╕зр╕▓р╕бр╕Ир╕│р╣Бр╕ер╣Йр╕зр╣Гр╕лр╣Йр╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф
        buffer = io.BytesIO()
        with pd.ExcelWriter(buffer, engine="openpyxl") as writer:
            merged.to_excel(writer, index=False, sheet_name="Result")

        st.success("тЬЕ р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕кр╕гр╣Зр╕Ир╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в! р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╣Др╕Фр╣Йр╣Ар╕ер╕в тЖУ")
        st.download_button(
            label="ЁЯУе р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М",
            data=buffer.getvalue(),
            file_name="vlookup_result.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        )

    # -----------------------------------------------------
    # р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е (optional)
    # -----------------------------------------------------

    with st.expander("ЁЯФН р╕Фр╕╣р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З F1 (р╕лр╕▒р╕з 5 р╣Бр╕Цр╕з)"):
        st.dataframe(df1.head())

    with st.expander("ЁЯФН р╕Фр╕╣р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З F2 (р╕лр╕▒р╕з 5 р╣Бр╕Цр╕з)"):
        st.dataframe(df2.head())

else:
    st.info("тмЖя╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М F1 р╣Бр╕ер╕░ F2 р╕Бр╣Ир╕нр╕Щр╣Ар╕гр╕┤р╣Ир╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Др╕гр╕▒р╕Ъ")

# ---------------------------------------------------------
# р╣Бр╕Цр╕Ър╕Фр╣Йр╕▓р╕Щр╕Вр╣Йр╕▓р╕З (Sidebar)
# ---------------------------------------------------------

st.sidebar.header("ЁЯУЭ р╕зр╕┤р╕Шр╕╡р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Йр╕Ър╕▒р╕Ър╕вр╣Ир╕н")

st.sidebar.markdown(
    """
1. р╕Бр╕Ф **Browse files** р╣Ар╕Юр╕╖р╣Ир╕нр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М Excel F1 р╣Бр╕ер╕░ F2  
2. р╣Ар╕ер╕╖р╕нр╕Бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Др╕╡р╕вр╣М / р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М  
3. р╕Бр╕Ф **р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф**  
4. р╕гр╕▒р╕Ър╣Др╕Яр╕ер╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М `.xlsx` р╣Гр╕Щр╕Чр╕▒р╕Щр╕Чр╕╡  

> тЪая╕П р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Ар╕лр╣Зр╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е р╣Гр╕лр╣Йр╕ер╕нр╕Зр╕гр╕╡р╣Ар╕Яр╕гр╕Кр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ър╕лр╕гр╕╖р╕нр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╣Гр╕лр╕бр╣И
"""
)
